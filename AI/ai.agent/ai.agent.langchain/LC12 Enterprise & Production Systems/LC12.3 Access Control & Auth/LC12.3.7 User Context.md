| **Subtopic** | **Focus** | **Key Concepts** | **One-Line Recall** |
|---|---|---|---|
| **LC12.3.7.1 Context Passing** | Pattern | Pass user through request | User context available everywhere. |
| **LC12.3.7.2 Personalization** | Application | Customize based on user | Tailor responses to user. |
| **LC12.3.7.3 User Preferences** | Storage | Store user settings | Remember user choices. |
| **LC12.3.7.4 Audit Trail** | Logging | Track who did what | Log user actions. |
| **LC12.3.7.5 User Metadata** | Data | Additional user information | Department, role, location, etc. |

# User Context: Personalizing LangChain

Injecting user context into LangChain applications.

```python
from contextvars import ContextVar

# Thread-safe user context
user_context: ContextVar[dict] = ContextVar('user_context', default={})

class UserContextMiddleware:
    async def __call__(self, request, call_next):
        # Set user context from JWT
        user_data = {
            "user_id": request.state.user_id,
            "tenant_id": request.state.tenant_id,
            "roles": request.state.roles,
            "preferences": await user_service.get_preferences(request.state.user_id)
        }
        
        user_context.set(user_data)
        
        response = await call_next(request)
        return response

# Use in chains
class PersonalizedChain:
    def invoke(self, query: str):
        ctx = user_context.get()
        
        # Personalize system prompt
        system_prompt = f"""
You are assisting {ctx['user_id']}.
User preferences: {ctx['preferences']}
Adjust tone and style accordingly.
"""
        
        messages = [
            SystemMessage(content=system_prompt),
            HumanMessage(content=query)
        ]
        
        return llm.invoke(messages)

# Audit logging
def log_action(action: str, resource: str):
    ctx = user_context.get()
    
    audit_log.record({
        "user_id": ctx["user_id"],
        "action": action,
        "resource": resource,
        "timestamp": datetime.utcnow()
    })
```

**Quick Ref:** Store user context in request state, use for personalization and audit logging.
