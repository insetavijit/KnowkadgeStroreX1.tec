| **Subtopic**                                   | **Focus & Purpose**                     | **Key Concepts / Details**                                                    | **One-Line Recall**                                             |
| ---------------------------------------------- | --------------------------------------- | ----------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **LC10.5.2.1 Sync Wrapper around Async**       | Compatibility                           | How RunnableLambda handles async def functions                                | RunnableLambda wraps async def functions seamlessly.            |
| **LC10.5.2.2 Invoke vs Ainvoke**               | Execution modes                         | Call sync func in async chain (threadpool) and vice versa (event loop)        | LCEL handles the sync/async bridge automatically.               |
| **LC10.5.2.3 Concurrent Execution**            | Performance                             | abatch() utilizing async nature for true parallelism                          | Async lambdas enable true concurrency in abatch().              |
| **LC10.5.2.4 Streaming Generators**            | Real-time                               | async def / yield pattern for custom streaming logic                          | Use async generators to build custom streaming steps.           |
| **LC10.5.2.5 Event Loop Gotchas**              | Pitfalls                                | Blocking the loop with heavy CPU tasks inside ainvoke                         | Don't block the event loop; offload CPU work.                   |

# Async Lambdas: Non-Blocking Logic

In modern AI (web scraping, API calls, DB writes), **Async is standard**. `RunnableLambda` unifies sync and async worlds so you don't have to manage the Event Loop manually.

---

## 1. Sync Wrapper around Async

You can pass an `async def` to `RunnableLambda`.

```python
async def get_weather(city):
    return await weather_api.get(city)

chain = RunnableLambda(get_weather)
```

*   `chain.ainvoke("London")`: Awaits the coroutine (Native performance).
*   `chain.invoke("London")`: Runs the coroutine in a new event loop loop (Bridge).

**Magic**: You can use async functions in sync chains!

---

## 2. Invoke vs Ainvoke (The Bridge)

*   **Async Function in Sync Chain**: Runs in a thread/loop wrapper.
*   **Sync Function in Async Chain**: Runs in a `run_in_executor` thread pool to avoid blocking the main loop.

This means you can mix and match `def` and `async def` steps in the same chain without crashing.

---

## 3. Streaming Generators

This is the power feature. You can write custom logic that streams tokens!

```python
async def split_words(text):
    for word in text.split(" "):
        yield word + " "
        await asyncio.sleep(0.1) # Simulate delay

stream_chain = RunnableLambda(split_words)

async for chunk in stream_chain.astream("Hello World"):
    print(chunk)
```

This allows you to make **anything** behave like an LLM stream (e.g., streaming DB rows).

---

## 4. Concurrent Execution (abatch)

If your lambda does IO (network requests), `abatch` gives you massive speedups.

```python
# Process 10 items in parallel
results = await chain.abatch(items)
```

If `chain` uses `async def`, these run concurrently on the event loop. Input size 100 takes the same time as input size 1!

---

## 5. Event Loop Gotchas

**Don't block the loop.**

```python
# BAD
async def bad_math(x):
    time.sleep(5)  # BLOCKS EVERYTHING
    return x

# GOOD
async def good_math(x):
    await asyncio.sleep(5) # Yields control
    return x
```

If you must run blocking CPU code (e.g., image resizing) inside an async chain, wrap it in a standard `def`â€”LCEL will put it in a separate thread automatically.

---

## Quick Reference

| Feature | Usage |
|---------|-------|
| **Wrapper** | `RunnableLambda(async_func)` |
| **Streaming** | `async def` + `yield` |
| **Bridge** | Auto-converts sync/async calls |
| **Safety** | Sync code runs in threads during async execution |
| **Tip** | Prefer `async def` for anything touching the network |
