| **Subtopic**                                   | **Focus & Purpose**                     | **Key Concepts / Details**                                                    | **One-Line Recall**                                             |
| ---------------------------------------------- | --------------------------------------- | ----------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **LC11.2.7.1 Resizing**                        | Size optimization                       | Reducing image dimensions for faster processing                               | Resize to ~1024px to save tokens and speed.                     |
| **LC11.2.7.2 Format Conversion**               | Compatibility                           | Converting to JPEG for efficiency                                             | JPEG is usually best for VLM APIs.                              |
| **LC11.2.7.3 Quality Compression**             | File size                               | Balancing quality vs file size                                                | Quality 85 JPEG is a good balance.                              |
| **LC11.2.7.4 Color Space**                     | Standardization                         | Converting RGBA to RGB; handling modes                                        | Convert RGBA to RGB for JPEG.                                   |
| **LC11.2.7.5 Preprocessing Pipeline**          | Automation                              | Building standard preprocessing utilities                                     | Build reusable preprocessing functions.                         |

# Image Preprocessing: Preparing Images for Processing

Resizing, converting, and optimizing images before sending to VLMs.

---

## 1. Why Preprocess?

| Issue | Impact | Solution |
|-------|--------|----------|
| **Large files** | More tokens, cost | Resize |
| **Wrong format** | Errors | Convert |
| **Transparency** | JPEG incompatible | Remove alpha |
| **Slow upload** | High latency | Compress |

---

## 2. Resizing

Keep images under 1024x1024 for most use cases:

```python
from PIL import Image

def resize_image(img: Image.Image, max_size: int = 1024) -> Image.Image:
    """Resize while maintaining aspect ratio."""
    img.thumbnail((max_size, max_size), Image.Resampling.LANCZOS)
    return img
```

**Note**: `thumbnail()` modifies in-place and maintains aspect ratio.

---

## 3. Format Conversion

```python
def convert_to_jpeg(img: Image.Image) -> Image.Image:
    """Convert to JPEG-compatible RGB mode."""
    if img.mode in ("RGBA", "P", "LA"):
        # Create white background for transparency
        background = Image.new("RGB", img.size, (255, 255, 255))
        if img.mode == "RGBA":
            background.paste(img, mask=img.split()[3])  # Use alpha as mask
        else:
            background.paste(img)
        return background
    elif img.mode != "RGB":
        return img.convert("RGB")
    return img
```

---

## 4. Quality Compression

```python
import io

def compress_image(img: Image.Image, quality: int = 85) -> bytes:
    """Compress to JPEG with specified quality."""
    buffer = io.BytesIO()
    img.save(buffer, format="JPEG", quality=quality, optimize=True)
    return buffer.getvalue()
```

| Quality | File Size (Relative) |
|---------|----------------------|
| **95** | 100% |
| **85** | ~50% |
| **75** | ~30% |

---

## 5. Complete Preprocessing Pipeline

```python
from PIL import Image
import io
import base64
from pathlib import Path

class ImagePreprocessor:
    def __init__(
        self,
        max_size: int = 1024,
        quality: int = 85
    ):
        self.max_size = max_size
        self.quality = quality
    
    def process(self, source: str | Path | Image.Image) -> str:
        """Load, preprocess, and return data URI."""
        # Load if path
        if isinstance(source, (str, Path)):
            img = Image.open(source)
        else:
            img = source
        
        # Resize
        img.thumbnail((self.max_size, self.max_size), Image.Resampling.LANCZOS)
        
        # Convert color mode
        if img.mode in ("RGBA", "P", "LA"):
            bg = Image.new("RGB", img.size, (255, 255, 255))
            if img.mode == "RGBA":
                bg.paste(img, mask=img.split()[3])
            else:
                bg.paste(img)
            img = bg
        elif img.mode != "RGB":
            img = img.convert("RGB")
        
        # Compress and encode
        buffer = io.BytesIO()
        img.save(buffer, format="JPEG", quality=self.quality, optimize=True)
        encoded = base64.b64encode(buffer.getvalue()).decode()
        
        return f"data:image/jpeg;base64,{encoded}"

# Usage
preprocessor = ImagePreprocessor()
data_uri = preprocessor.process("./photo.png")
```

---

## Quick Reference

| Step | Function |
|------|----------|
| **Load** | `Image.open(path)` |
| **Resize** | `img.thumbnail((max, max))` |
| **Mode Fix** | `img.convert("RGB")` |
| **Compress** | `img.save(..., quality=85)` |
| **Encode** | `base64.b64encode()` |
