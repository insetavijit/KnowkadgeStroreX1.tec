| **Subtopic**                                   | **Focus & Purpose**                     | **Key Concepts / Details**                                                    | **One-Line Recall**                                             |
| ---------------------------------------------- | --------------------------------------- | ----------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **LC11.4.7.1 Audio Formats**                   | Compatibility                           | MP3, WAV, FLAC, M4A, OGG support                                              | Whisper supports mp3, wav, flac, m4a, ogg, webm.                |
| **LC11.4.7.2 Loading Audio**                   | Read                                    | Loading audio files in Python                                                 | Use pydub or librosa to load audio.                             |
| **LC11.4.7.3 Format Conversion**               | Processing                              | Converting between audio formats                                              | Convert to standard format before processing.                   |
| **LC11.4.7.4 Audio Preprocessing**             | Quality                                 | Noise reduction, normalization                                                | Preprocess audio for better transcription.                      |
| **LC11.4.7.5 Compression**                     | Size                                    | Reducing file size while maintaining quality                                  | Compress audio to reduce API payload size.                      |

# Audio File Handling: Working with Sound Files

Preparing audio files for processing pipelines.

---

## 1. Supported Audio Formats

**Whisper API supports**:
| Format | Extension | Notes |
|--------|-----------|-------|
| **MP3** | .mp3 | Most common, good compression |
| **WAV** | .wav | Uncompressed, large files |
| **FLAC** | .flac | Lossless compression |
| **M4A** | .m4a | Apple format, good quality |
| **OGG** | .ogg | Open format |
| **WebM** | .webm | Web audio |

---

## 2. Loading Audio

**Using pydub** (recommended):
```bash
pip install pydub
```

```python
from pydub import AudioSegment

# Load various formats
audio = AudioSegment.from_file("audio.mp3")
audio = AudioSegment.from_file("audio.wav")
audio = AudioSegment.from_file("audio.m4a")

# Get properties
duration_ms = len(audio)
sample_rate = audio.frame_rate
channels = audio.channels
```

**Using librosa** (for analysis):
```bash
pip install librosa
```

```python
import librosa

# Load audio (always returns mono by default)
y, sr = librosa.load("audio.mp3", sr=16000)  # Resample to 16kHz
duration = librosa.get_duration(y=y, sr=sr)
```

---

## 3. Format Conversion

```python
from pydub import AudioSegment

def convert_to_mp3(input_path: str, output_path: str = None, 
                   bitrate: str = "128k") -> str:
    """Convert any audio format to MP3."""
    if output_path is None:
        output_path = input_path.rsplit(".", 1)[0] + ".mp3"
    
    audio = AudioSegment.from_file(input_path)
    audio.export(output_path, format="mp3", bitrate=bitrate)
    
    return output_path

# Convert WAV to MP3
convert_to_mp3("recording.wav", "recording.mp3")
```

---

## 4. Audio Preprocessing

**Improve transcription quality**:

```python
from pydub import AudioSegment
from pydub.effects import normalize, compress_dynamic_range

def preprocess_audio(audio_path: str) -> AudioSegment:
    """Preprocess audio for better transcription."""
    audio = AudioSegment.from_file(audio_path)
    
    # Convert to mono
    audio = audio.set_channels(1)
    
    # Set sample rate to 16kHz (optimal for Whisper)
    audio = audio.set_frame_rate(16000)
    
    # Normalize volume
    audio = normalize(audio)
    
    # Compress dynamic range (reduce loud/quiet variation)
    audio = compress_dynamic_range(audio)
    
    return audio
```

**Noise reduction** (using noisereduce):
```bash
pip install noisereduce
```

```python
import noisereduce as nr
import numpy as np
from pydub import AudioSegment

def reduce_noise(audio: AudioSegment) -> AudioSegment:
    """Apply noise reduction."""
    samples = np.array(audio.get_array_of_samples())
    
    # Reduce noise
    reduced = nr.reduce_noise(
        y=samples.astype(float),
        sr=audio.frame_rate
    )
    
    # Convert back to AudioSegment
    return AudioSegment(
        reduced.astype(np.int16).tobytes(),
        frame_rate=audio.frame_rate,
        sample_width=2,
        channels=1
    )
```

---

## 5. Compression for API

Reduce file size while maintaining quality:

```python
def compress_for_api(audio_path: str, max_size_mb: int = 20) -> str:
    """Compress audio to fit API limits."""
    import os
    
    audio = AudioSegment.from_file(audio_path)
    
    # Start with current settings
    bitrate = 128
    output_path = "temp_compressed.mp3"
    
    while True:
        audio.export(output_path, format="mp3", bitrate=f"{bitrate}k")
        
        size_mb = os.path.getsize(output_path) / (1024 * 1024)
        
        if size_mb <= max_size_mb:
            break
        
        # Reduce bitrate
        bitrate = max(32, bitrate - 32)
        if bitrate == 32 and size_mb > max_size_mb:
            raise ValueError("Cannot compress enough")
    
    return output_path
```

---

## Quick Reference

| Task | Tool/Method |
|------|-------------|
| **Load** | `pydub.AudioSegment.from_file()` |
| **Convert** | `audio.export(format="mp3")` |
| **Normalize** | `pydub.effects.normalize()` |
| **Noise Reduce** | `noisereduce.reduce_noise()` |
| **Compress** | Lower bitrate export |
