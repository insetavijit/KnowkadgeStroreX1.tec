| **Subtopic**                                   | **Focus & Purpose**                     | **Key Concepts / Details**                                                    | **One-Line Recall**                                             |
| ---------------------------------------------- | --------------------------------------- | ----------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **LC11.1.4.1 Image to Text Chain**             | Basic pipeline                          | Image -> VLM -> Text output                                                   | Image in, text out is the basic VLM chain.                      |
| **LC11.1.4.2 Structured Output from Images**   | Extraction                              | Using Pydantic models to parse VLM output                                     | Use output parsers to extract structured data from images.      |
| **LC11.1.4.3 Image + Prompt Templates**        | Templating                              | ChatPromptTemplate with image placeholders                                    | Templates can include image placeholders.                       |
| **LC11.1.4.4 Multi-Step Image Analysis**       | Complex workflows                       | Image -> Caption -> Summarize -> Tag                                          | Chain multiple steps for deep image analysis.                   |
| **LC11.1.4.5 Integration with RAG**            | Knowledge-grounded vision               | Image analysis + Document retrieval                                           | Combine VLMs with RAG for context-aware vision.                 |

# Image Analysis Chains: LCEL for Vision

Building workflows that take images as input and produce structured outputs.

---

## 1. Basic Image-to-Text Chain

```python
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage

llm = ChatOpenAI(model="gpt-4o")

def analyze_image(image_url: str, question: str) -> str:
    message = HumanMessage(
        content=[
            {"type": "text", "text": question},
            {"type": "image_url", "image_url": {"url": image_url}}
        ]
    )
    response = llm.invoke([message])
    return response.content
```

This is procedural. Let's make it LCEL.

---

## 2. LCEL with Image Input

```python
from langchain_core.runnables import RunnableLambda

def build_vision_message(inputs: dict):
    return [HumanMessage(
        content=[
            {"type": "text", "text": inputs["question"]},
            {"type": "image_url", "image_url": {"url": inputs["image_url"]}}
        ]
    )]

vision_chain = (
    RunnableLambda(build_vision_message)
    | llm
    | StrOutputParser()
)

result = vision_chain.invoke({
    "image_url": "https://example.com/chart.png",
    "question": "What are the top 3 categories?"
})
```

---

## 3. Structured Output from Images

```python
from pydantic import BaseModel
from langchain_core.output_parsers import PydanticOutputParser

class ChartAnalysis(BaseModel):
    title: str
    categories: list[str]
    largest_value: float
    trend: str

parser = PydanticOutputParser(pydantic_object=ChartAnalysis)

prompt_text = f"""Analyze this chart and extract:
{parser.get_format_instructions()}
"""

# Build chain with structured output
structured_vision_chain = (
    RunnableLambda(lambda x: [HumanMessage(content=[
        {"type": "text", "text": prompt_text},
        {"type": "image_url", "image_url": {"url": x["image_url"]}}
    ])])
    | llm
    | parser
)
```

---

## 4. Multi-Step Analysis Pipeline

```python
caption_chain = (
    build_message("Describe this image in one sentence.")
    | llm
    | StrOutputParser()
)

tag_chain = (
    ChatPromptTemplate.from_template("Extract 5 tags from: {caption}")
    | llm
    | StrOutputParser()
)

full_pipeline = (
    RunnablePassthrough.assign(caption=caption_chain)
    | RunnablePassthrough.assign(tags=tag_chain)
)

# Result: {"image_url": ..., "caption": "...", "tags": "..."}
```

---

## Quick Reference

| Pattern | Use Case |
|---------|----------|
| **Image -> Text** | Captions, descriptions |
| **Image -> Structured** | Data extraction (charts, receipts) |
| **Multi-Step** | Complex analysis pipelines |
| **Image + RAG** | Context-aware responses |
