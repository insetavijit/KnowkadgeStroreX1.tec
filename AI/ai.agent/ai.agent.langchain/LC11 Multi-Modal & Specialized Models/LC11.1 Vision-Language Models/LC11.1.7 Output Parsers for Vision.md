| **Subtopic**                                   | **Focus & Purpose**                     | **Key Concepts / Details**                                                    | **One-Line Recall**                                             |
| ---------------------------------------------- | --------------------------------------- | ----------------------------------------------------------------------------- | --------------------------------------------------------------- |
| **LC11.1.7.1 JSON from Images**                | Extraction                              | Extracting structured JSON from visual content                                | VLMs can output JSON describing what they see.                  |
| **LC11.1.7.2 Pydantic Parsers**                | Validation                              | Using PydanticOutputParser with vision chains                                 | Validate VLM output with Pydantic models.                       |
| **LC11.1.7.3 OCR + Parsing**                   | Text extraction                         | Reading text in images and structuring it                                     | VLMs can perform OCR and structure the results.                 |
| **LC11.1.7.4 Table Extraction**                | Documents                               | Extracting tabular data from images of tables                                 | VLMs can extract tables to JSON/CSV format.                     |
| **LC11.1.7.5 Error Handling**                  | Robustness                              | Handling cases where vision output doesn't parse                              | Vision output parsing needs extra error handling.               |

# Output Parsers for Vision: Structured Extraction

VLMs return text, but we often need structured data.
Output parsers bridge this gap.

---

## 1. JSON from Images

Tell the VLM to output JSON:

```python
prompt = """
Analyze this receipt image and output JSON:
{
  "store_name": string,
  "date": string,
  "items": [{"name": string, "price": float}],
  "total": float
}
"""

message = HumanMessage(
    content=[
        {"type": "text", "text": prompt},
        {"type": "image_url", "image_url": {"url": receipt_url}}
    ]
)
```

---

## 2. Pydantic Output Parser

```python
from pydantic import BaseModel, Field
from langchain_core.output_parsers import PydanticOutputParser

class ReceiptData(BaseModel):
    store_name: str
    date: str
    items: list[dict]
    total: float

parser = PydanticOutputParser(pydantic_object=ReceiptData)

prompt = f"""
Analyze this receipt.
{parser.get_format_instructions()}
"""

chain = (
    build_vision_message(prompt)
    | llm
    | parser
)

receipt: ReceiptData = chain.invoke({"image_url": receipt_url})
```

---

## 3. OCR + Structuring

VLMs are excellent at reading text in images:

```python
prompt = """
Read all text visible in this image.
Output as JSON:
{
  "title": "main heading",
  "body": ["line 1", "line 2", ...],
  "footer": "text at bottom"
}
"""
```

For complex documents (multi-column, handwriting), specialized OCR may be better.

---

## 4. Table Extraction

```python
class TableData(BaseModel):
    headers: list[str]
    rows: list[list[str]]

prompt = f"""
Extract the table from this image.
{parser.get_format_instructions()}
"""
```

**Output**:
```json
{
  "headers": ["Name", "Age", "City"],
  "rows": [
    ["Alice", "30", "NYC"],
    ["Bob", "25", "LA"]
  ]
}
```

---

## 5. Error Handling

VLM output can be malformed. Always wrap parsing:

```python
from langchain.output_parsers import OutputFixingParser

fixing_parser = OutputFixingParser.from_llm(
    parser=parser,
    llm=llm
)

# Attempts to fix invalid JSON before raising
```

Or use try/except:

```python
try:
    result = chain.invoke(input)
except OutputParserException:
    # Fallback to raw text or retry
    result = {"raw_text": response.content}
```

---

## Quick Reference

| Pattern | Use Case |
|---------|----------|
| **Pydantic** | Enforce schema |
| **OutputFixingParser** | Auto-fix malformed JSON |
| **Retry** | Re-prompt on failure |
| **Fallback** | Return raw text if parsing fails |
